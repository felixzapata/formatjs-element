<link rel="import" href="../polymer/polymer.html">

<script>
  (function() {
    'use strict';


    Polymer.intlFormaterBehavior = {
   
      properties: {
        intlFormater: {
          type: Object
        },
        messages: {
          type:Object
        },
        msg: {
          type:String,
          value: ''
        }
        
      },
      
      /**
      * Returns if the message contain values for plurals.
      *
      * @param {Object} messages Strings to translate.
      * @param {String} key Value to find inside the messages
      * @return {Boolean}.
      */
      _noSyntax: function(key){
        return !this.messages[key].hasOwnProperty('message');
      },
      
      _get: function(obj, property){
        if(obj.hasOwnProperty(property)){
          return obj[property];
        }else {
          return '';
        }
      },
      
      _parseType: function(text, key, type){
        text = text.replace('{' + key  + '}', '{' + key  + ', ' + type + '}', 'g')
        return "'" + text + "'";
      },
      
      _parseFormat: function(text, format, key, values){
        var pluralFormat = '';
        var partial = text;
        if(format === 'plural'){
          return this._parsePlural(text, values);
        }
      },
      
      _parsePlural: function(msg, values){
        var text = '';
        var pluralFormat = '';
        for(var i in values){
          if(values.hasOwnProperty(i)) {
            pluralFormat += ' ' + i + ' {' + values[i] + '}';
          }
        }
        return pluralFormat;
      },
      
      /**
      * Parse.
      *
      * @param {Object} messages Strings to translate.
      * @param {String} key Value to find inside the messages
      * @return {String} Formated text following ICU Message syntax and CLDR locale data. 
      */
      _parse: function(key){           
        var text = this.messages[key].message;
        var formattedText = key + ': ';
        var syntax = this.messages[key].syntax;
        var keys = Object.keys(syntax);
        var values;
        var type;
        var format;
        
        for(var value in syntax){
          if(syntax.hasOwnProperty(value)){
            format = this._get(syntax[value], 'format');
            values = this._get(syntax[value], 'values');
            type = this._get(syntax[value], 'type');
          }
          if(format !== ''){
            formattedText = this._parseFormat(text, format, value, values);
            text = text.replace('{' + value  + '}', '{' + value  + ', ' + format + ', ' + formattedText + '}', 'g');
          } 
          if (type !== ''){
            text = this._parseType(text, value, type);
          } 
        }
        return text
      },

      /**
      * Parse a simple message (no plurals neither dates...).
      *
      * @param {Object} messages Strings to translate.
      * @param {String} key Value to find inside the messages
      * @return {String} Formated text following ICU Message syntax and CLDR locale data. 
      */
      _parseSimple: function(key){
        return this.messages[key];
      },
      
      /**
      * Format a message following ICU Message syntax and CLDR locale data
      *
      * @param {Object} messages Strings to translate.
      * @return {Object} Formatted text. 
      */
      formatIntl: function(msg){
        var obj = {};
        this.messages = msg;
        for(var i in this.messages){
          if(msg.hasOwnProperty(i)){
            if(this._noSyntax(i)){
              obj[i] =  this._parseSimple(i)
            } else {
              obj[i] = this._parse(i);
            }
          }
        }
        return obj;  
      }
         
    };
  })();

</script>