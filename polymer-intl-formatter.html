<link rel="import" href="../polymer/polymer.html">

<script>
  (function() {
    'use strict';


    Polymer.intlFormaterBehavior = {
   
      properties: {
        intlFormater: {
          type: Object
        },
        messages: {
          type: Object
        },
        message: {
          type: String,
          value: ''
        }        
      },
      
      /**
      * Returns if the message contain values for plurals.
      *
      * @param {Object} messages Strings to translate.
      * @param {String} key Value to find inside the messages
      * @return {Boolean}.
      */
      _noSyntax: function(key){
        return !this.messages[key].hasOwnProperty('message');
      },
      
      _get: function(obj, property){
        if(obj.hasOwnProperty(property)){
          return obj[property];
        }else {
          return '';
        }
      },
      
      _parseType: function(key, type){
        this.message = this.message.replace('{' + key  + '}', '{' + key  + ', ' + type + '}', 'g')
        return this.message;
      },
      
      _parseFormat: function(format, key, values){
        var pluralFormat = '';
        if(format === 'plural'){
          return this._parsePlural(this.message, values);
        }
      },
      
      _parsePlural: function(msg, values){
        var pluralFormat = '';
        for(var i in values){
          if(values.hasOwnProperty(i)) {
            pluralFormat += ' ' + i + ' {' + values[i] + '}';
          }
        }
        return pluralFormat;
      },
      
      /**
      * Parse.
      *
      * @param {Object} messages Strings to translate.
      * @param {String} key Value to find inside the messages
      * @return {String} Formated text following ICU Message syntax and CLDR locale data. 
      */
      _parse: function(key){           
        this.message = this.messages[key].message;
        var formattedText = key + ': ';
        var syntax = this.messages[key].syntax;
        var keys = Object.keys(syntax);
        var values;
        var type;
        var format;
        
        for(var key in syntax){
          if(syntax.hasOwnProperty(key)){
            format = this._get(syntax[key], 'format');
            values = this._get(syntax[key], 'values');
            type = this._get(syntax[key], 'type');
          }
          if(format !== ''){
            formattedText = this._parseFormat(format, key, values);
            this.message = this.message.replace('{' + key  + '}', '{' + key  + ', ' + format + ',' + formattedText + '}', 'g');
          } 
          if (type !== ''){
            this.message = this._parseType(key, type);
          } 
        }
        return this.message;
      },

      /**
      * Parse a simple message (no plurals neither dates...).
      *
      * @param {Object} messages Strings to translate.
      * @param {String} key Value to find inside the messages
      * @return {String} Formated text following ICU Message syntax and CLDR locale data. 
      */
      _parseSimple: function(key){
        return this.messages[key];
      },
      
      /**
      * Format a message following ICU Message syntax and CLDR locale data
      *
      * @param {Object} messages Strings to translate.
      * @return {Object} Formatted text. 
      */
      formatIntl: function(msg){
        var obj = {};
        this.messages = msg;
        for(var i in this.messages){
          if(msg.hasOwnProperty(i)){
            if(this._noSyntax(i)){
              obj[i] =  this._parseSimple(i)
            } else {
              obj[i] = this._parse(i);
            }
          }
        }
        return obj;  
      }
         
    };
  })();

</script>